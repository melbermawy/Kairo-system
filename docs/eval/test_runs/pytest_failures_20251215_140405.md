# Pytest Failure Reconciliation Report

**Generated:** 2025-12-15T14:04:05Z
**PR:** PR-11 (Observability, Classification, and Admin Surfaces)

## Test Environment

```
Python version: 3.13.5
Django version: 5.2.9
pytest version: 8.4.2
pytest-django version: 4.11.1

Database URL: sqlite://:memory: (in-memory SQLite for tests)
LLM_DISABLED: true
DJANGO_SETTINGS_MODULE: kairo.settings (from pyproject.toml)

Migrations: Applied automatically via pytest-django
```

## Pytest Command

```bash
DATABASE_URL=sqlite://:memory: LLM_DISABLED=true python -m pytest --tb=short -v
```

## Initial Failure Summary

**Before fix:** 106 failed, 640 passed
**After fix:** 0 failed, 746 passed

## Root Cause Analysis

### Failure Category: API Contract Mismatch (106 tests)

**Cause:** PR-11 renamed `log_classification()` parameters without updating all call sites.

| Old Parameter | New Parameter |
|--------------|---------------|
| `f1_label`   | `f1_health`   |
| `f2_label`   | `f2_health`   |
| `run_label`  | `run_health`  |

**Error signature:**
```
TypeError: log_classification() got an unexpected keyword argument 'f1_label'
```

**Affected files (callers):**
1. `kairo/hero/engines/opportunities_engine.py` (2 call sites: lines 199, 234)
2. `kairo/hero/engines/content_engine.py` (2 call sites: lines 398, 460)

**Fix applied:** Updated all 4 call sites to use new parameter names (`f1_health`, `f2_health`, `run_health`).

## Grouped Failure Summary

| Category | Count | Likely Cause | Fix Applied |
|----------|-------|--------------|-------------|
| API Contract Mismatch | 106 | PR-11 parameter rename | Yes |
| DB/Schema | 0 | N/A | N/A |
| Import Error | 0 | N/A | N/A |
| Assertion Mismatch | 0 | N/A | N/A |
| Flaky/Timeout | 0 | N/A | N/A |

## First 30 Failing Tests (Before Fix)

All 106 failures had the same root cause. Sample failures:

1. `tests/test_content_engine_integration.py::TestVariantGeneration::test_engine_calls_graph_and_returns_variants`
2. `tests/test_content_engine_integration.py::TestVariantGeneration::test_engine_persists_variant_rows`
3. `tests/test_content_engine_integration.py::TestVariantGeneration::test_persisted_variants_have_correct_fields`
4. `tests/test_content_engine_integration.py::TestNoRegeneration::test_regeneration_raises_error`
5. `tests/test_content_engine_integration.py::TestNoRegeneration::test_no_regeneration_doesnt_call_graph`
6. `tests/test_content_engine_integration.py::TestErrorHandling::test_variants_graph_error_raises_variant_generation_error`
7. `tests/test_content_engine_integration.py::TestInvalidVariantFiltering::test_invalid_variants_not_persisted`
8. `tests/test_content_engine_integration.py::TestDtoConversion::test_variant_to_dto_roundtrip`
9. `tests/test_content_engine_integration.py::TestTabooEnforcement::test_variant_with_taboo_in_body_filtered`
10. `tests/test_content_engine_integration.py::TestMetricsSnapshot::test_variant_stores_quality_metrics`
11. `tests/test_engines_stub_behavior.py::TestOpportunitiesEngine::test_returns_today_board_dto`
12. `tests/test_engines_stub_behavior.py::TestOpportunitiesEngine::test_brand_id_matches`
13. `tests/test_engines_stub_behavior.py::TestOpportunitiesEngine::test_snapshot_has_brand_data`
14. `tests/test_engines_stub_behavior.py::TestOpportunitiesEngine::test_returns_6_to_10_opportunities`
15. `tests/test_engines_stub_behavior.py::TestOpportunitiesEngine::test_opportunity_scores_in_valid_range`
16. `tests/test_engines_stub_behavior.py::TestOpportunitiesEngine::test_opportunity_scores_in_stub_range`
17. `tests/test_engines_stub_behavior.py::TestOpportunitiesEngine::test_opportunity_channels_valid`
18. `tests/test_engines_stub_behavior.py::TestOpportunitiesEngine::test_opportunities_sorted_by_score_descending`
19. `tests/test_engines_stub_behavior.py::TestOpportunitiesEngine::test_opportunity_types_valid`
20. `tests/test_engines_stub_behavior.py::TestOpportunitiesEngine::test_meta_has_correct_opportunity_count`
21. `tests/test_engines_stub_behavior.py::TestOpportunitiesEngine::test_meta_has_channel_mix`
22. `tests/test_engines_stub_behavior.py::TestOpportunitiesEngine::test_meta_source_is_hero_f1`
23. `tests/test_engines_stub_behavior.py::TestOpportunitiesEngine::test_meta_degraded_is_false`
24. `tests/test_engines_stub_behavior.py::TestOpportunitiesEngine::test_deterministic_output`
25. `tests/test_engines_stub_behavior.py::TestContentEngine::test_generate_variants_returns_list`
26. `tests/test_engines_stub_behavior.py::TestContentEngine::test_generate_variants_returns_two_channels`
27. `tests/test_engines_stub_behavior.py::TestContentEngine::test_generate_variants_have_body`
28. `tests/test_engines_stub_behavior.py::TestContentEngine::test_generate_variants_have_draft_status`
29. `tests/test_engines_stub_behavior.py::TestContentEngine::test_generate_variants_persisted`
30. `tests/test_engines_stub_behavior.py::TestContentEngine::test_generate_variants_no_regeneration`

**Full traceback (representative):**
```
tests/test_engines_stub_behavior.py::TestOpportunitiesEngine::test_returns_today_board_dto
    kairo/hero/services/today_service.py:33: in get_today_board
        return opportunities_engine.generate_today_board(brand_id)
    kairo/hero/engines/opportunities_engine.py:199: in generate_today_board
        log_classification(
    TypeError: log_classification() got an unexpected keyword argument 'f1_label'
```

## PR-11 Specific Tests

**Command:**
```bash
DATABASE_URL=sqlite://:memory: LLM_DISABLED=true python -m pytest tests/test_internal_views.py tests/test_observability_store.py -v
```

**Result:** 74 passed, 0 failed

PR-11 specific tests include:
- Token auth tests (5)
- Run browser tests (8)
- Eval browser tests (6)
- Brand browser tests (6)
- Strict auth tests (4)
- JSON schema tests (2)
- XSS security tests (3)
- Filesystem isolation tests (3)
- Observability store tests (37)

## Conclusion

**All 106 failures were introduced by PR-11** due to incomplete parameter rename propagation. The fix has been applied to all affected files:

1. `kairo/hero/engines/opportunities_engine.py` - Updated 2 call sites
2. `kairo/hero/engines/content_engine.py` - Updated 2 call sites

**Final test result: 746 passed, 0 failed**

## Files Changed in This Fix

| File | Change |
|------|--------|
| `kairo/hero/engines/opportunities_engine.py` | Updated `log_classification()` calls to use `f1_health`, `f2_health`, `run_health` |
| `kairo/hero/engines/content_engine.py` | Updated `log_classification()` calls to use `f1_health`, `f2_health`, `run_health` |
